name: Benchmarks
on:
  # push:
  #   branches: [main]
  #   paths: ['src/**', 'benches/**', 'Cargo.toml', 'Cargo.lock']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  benchmark:
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux-x86_64
          - os: macos-26
            platform: darwin-arm64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2

      - uses: Swatinem/rust-cache@v2

      - name: Build release
        run: cargo build --release

      - name: Install coreutils (macOS)
        if: runner.os == 'macOS'
        run: brew install coreutils

      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: benches/data
          key: bench-data-v1

      - name: Download/generate test data
        run: |
          bash benches/download_data.sh --json --gharchive
          bash benches/generate_data.sh --all

      - name: Run benchmarks
        run: cargo run --release --bin bench_tools -- --type json --runs 3 --cooldown 3 --output benches/results_json_ci.md

      - name: Run memory benchmarks
        run: |
          cargo run --release --bin bench_mem -- --type json --runs 3 --output benches/results_mem_json_ci.md
          cargo run --release --bin bench_mem -- --type ndjson --runs 3 --output benches/results_mem_ndjson_ci.md

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-${{ matrix.platform }}
          path: |
            benches/results_json_ci.md
            benches/results_mem_json_ci.md
            benches/results_mem_ndjson_ci.md
            benches/results/

  commit-results:
    needs: benchmark
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          pattern: benchmarks-*
          path: benches/artifacts/

      - name: Merge platform results into benches/results_json_ci.md
        run: |
          {
            echo "# Benchmarks (CI)"
            echo ""
            echo "> Auto-generated by CI on shared runners — directional only."
            echo "> For authoritative results, see [results_json.md](results_json.md) (run locally)."
            echo ""
            for dir in benches/artifacts/benchmarks-*/; do
              platform=$(basename "$dir" | sed 's/benchmarks-//')
              echo "## $platform"
              echo ""
              # Extract from "All benchmarks..." onward (skip per-file header)
              sed -n '/^All benchmarks/,$p' "$dir/benches/results_json_ci.md"
              echo ""
            done
          } > benches/results_json_ci.md

      - name: Merge memory results
        run: |
          for bench_type in json ndjson; do
            {
              echo "# Memory Usage — ${bench_type} (CI)"
              echo ""
              echo "> Auto-generated by CI on shared runners — directional only."
              echo ""
              for dir in benches/artifacts/benchmarks-*/; do
                platform=$(basename "$dir" | sed 's/benchmarks-//')
                f="$dir/benches/results_mem_${bench_type}_ci.md"
                if [ -f "$f" ]; then
                  echo "## $platform"
                  echo ""
                  cat "$f"
                  echo ""
                fi
              done
            } > "benches/results_mem_${bench_type}_ci.md"
          done

      - name: Commit CI results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add benches/results_json_ci.md benches/results_mem_*_ci.md
          git diff --staged --quiet || git commit -m "Update benchmark results [skip ci]"
          git push
