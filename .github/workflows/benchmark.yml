name: Benchmarks
on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to benchmark'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - linux
          - macos

permissions:
  contents: write

jobs:
  benchmark-linux:
    if: inputs.platform == 'all' || inputs.platform == 'linux'
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: jdx/mise-action@v2
      - uses: Swatinem/rust-cache@v2

      - name: Build release
        run: cargo build --release --features bench

      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: benches/data
          key: bench-data-v2

      - name: Download/generate test data
        run: |
          bash benches/download_data.sh --json --gharchive --no-gz
          bash benches/generate_data.sh

      - name: Run JSON benchmarks
        run: cargo run --release --features bench --bin bench_tools -- --type json --no-1t --runs 3 --cooldown 3 --output benches/results_json_ci.md

      - name: Run NDJSON benchmarks
        run: cargo run --release --features bench --bin bench_tools -- --type ndjson --no-1t --size small --runs 1 --cooldown 2 --output benches/results_ndjson_ci.md

      - name: Run memory benchmarks
        run: |
          cargo run --release --features bench --bin bench_mem -- --type json --no-1t --runs 3 --output benches/results_mem_json_ci.md
          cargo run --release --features bench --bin bench_mem -- --type ndjson --no-1t --runs 3 --output benches/results_mem_ndjson_ci.md

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-linux-x86_64
          path: |
            benches/results_json_ci.md
            benches/results_ndjson_ci.md
            benches/results_mem_json_ci.md
            benches/results_mem_ndjson_ci.md

  benchmark-macos:
    if: inputs.platform == 'all' || inputs.platform == 'macos'
    runs-on: macos-26
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: jdx/mise-action@v2
      - uses: Swatinem/rust-cache@v2

      - name: Build release
        run: cargo build --release --features bench

      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: benches/data
          key: bench-data-v2

      - name: Download/generate test data
        run: |
          bash benches/download_data.sh --json --gharchive --no-gz
          bash benches/generate_data.sh

      - name: Run JSON benchmarks
        run: cargo run --release --features bench --bin bench_tools -- --type json --no-1t --runs 3 --cooldown 3 --output benches/results_json_ci.md

      - name: Run NDJSON benchmarks
        run: cargo run --release --features bench --bin bench_tools -- --type ndjson --no-1t --size small --runs 1 --cooldown 2 --output benches/results_ndjson_ci.md

      - name: Run memory benchmarks
        run: |
          cargo run --release --features bench --bin bench_mem -- --type json --no-1t --runs 3 --output benches/results_mem_json_ci.md
          cargo run --release --features bench --bin bench_mem -- --type ndjson --no-1t --runs 3 --output benches/results_mem_ndjson_ci.md

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-darwin-arm64
          path: |
            benches/results_json_ci.md
            benches/results_ndjson_ci.md
            benches/results_mem_json_ci.md
            benches/results_mem_ndjson_ci.md

  commit-results:
    needs: [benchmark-linux, benchmark-macos]
    if: always() && !cancelled()
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          pattern: benchmarks-*
          path: benches/artifacts/

      - name: Merge results
        run: |
          result_file="benches/results_ci.md"
          {
            echo "# CI Benchmarks"
            echo ""
            echo "> Auto-generated by CI on shared GitHub Actions runners."
            echo "> These runners have variable performance due to shared tenancy and noisy neighbors."
            echo "> Treat these numbers as directional â€” for authoritative results, run on dedicated hardware."
            echo ""

            # Debug: show artifact structure
            echo "::group::Artifact structure"
            find benches/artifacts/ -type f 2>/dev/null || echo "(no artifacts found)"
            echo "::endgroup::"

            for bench_type in ndjson json; do
              type_label=$(echo "$bench_type" | tr '[:lower:]' '[:upper:]')
              echo "---"
              echo ""
              echo "## ${type_label} Speed"
              echo ""
              for dir in benches/artifacts/benchmarks-*/; do
                [ -d "$dir" ] || continue
                platform=$(basename "$dir" | sed 's/benchmarks-//')
                f=$(find "$dir" -name "results_${bench_type}_ci.md" -type f | head -1)
                if [ -n "$f" ]; then
                  echo "### $platform"
                  echo ""
                  cat "$f"
                  echo ""
                fi
              done

              echo "## ${type_label} Memory"
              echo ""
              for dir in benches/artifacts/benchmarks-*/; do
                [ -d "$dir" ] || continue
                platform=$(basename "$dir" | sed 's/benchmarks-//')
                f=$(find "$dir" -name "results_mem_${bench_type}_ci.md" -type f | head -1)
                if [ -n "$f" ]; then
                  echo "### $platform"
                  echo ""
                  cat "$f"
                  echo ""
                fi
              done
            done
          } > "$result_file"

      - name: Commit CI results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add benches/results_ci.md
          git diff --staged --quiet || git commit -m "Update benchmark results [skip ci]"
          git push
